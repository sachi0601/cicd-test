name: AWS Batch Rollback
run-name: Rollback ${{ inputs.environment }} by @${{ github.actor }}

"on":
  workflow_dispatch:
    inputs:
      environment:
        description: "Rollback target environment"
        type: choice
        required: true
        options: [dev, stage, prod]

concurrency:
  group: rollback-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  # ==============================================================
  # debug (必ず1個は走らせて入力を可視化)
  # ==============================================================
  debug:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "event_name=${{ github.event_name }}"
          echo "inputs.environment=${{ inputs.environment }}"
          echo "github.event.inputs.environment=${{ github.event.inputs.environment }}"

  # ==============================================================
  # dev rollback (no approval)
  # ==============================================================
  rollback-dev:
    if: ${{ inputs.environment == 'dev' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      id-token: write
      contents: read

    env:
      JOB_DEF_FAMILY: dev-mizuno-sv-cpi-batchj01

    steps:
      - name: resolve oidc role arn
        shell: bash
        run: |
          set -euo pipefail
          ROLE_ARN="${{ secrets.DEV_OIDC_ROLE_ARN }}"
          if [ -z "$ROLE_ARN" ]; then
            echo "ERROR: DEV_OIDC_ROLE_ARN is empty. Check secrets."
            exit 1
          fi
          echo "ROLE_ARN=$ROLE_ARN" >> "$GITHUB_ENV"

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ env.ROLE_ARN }}

      - name: rollback job definition (disable latest)
        shell: bash
        run: |
          set -euo pipefail
          ARNS="$(aws batch describe-job-definitions \
            --job-definition-name "${JOB_DEF_FAMILY}" \
            --status ACTIVE \
            --query 'jobDefinitions | sort_by(@, &revision) | reverse(@)[:2].jobDefinitionArn' \
            --output text)"

          COUNT="$(printf "%s" "${ARNS}" | wc -w | tr -d ' ')"
          if [ "${COUNT}" -lt 2 ]; then
            echo "ERROR: Less than 2 ACTIVE job definitions. Rollback not possible."
            exit 1
          fi

          read -r LATEST_ARN PREV_ARN <<< "${ARNS}"
          echo "Disable (latest): ${LATEST_ARN}"
          echo "Keep (previous) : ${PREV_ARN}"
          aws batch deregister-job-definition --job-definition "${LATEST_ARN}"

  # ==============================================================
  # stage/prod approve (Environment reviewers)
  # ==============================================================
  approve:
    if: ${{ inputs.environment != 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: echo "Approved. Start rollback for ${{ inputs.environment }}."

  # ==============================================================
  # stage/prod rollback (after approval)
  # ==============================================================
  rollback:
    if: ${{ inputs.environment != 'dev' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [approve]

    permissions:
      id-token: write
      contents: read

    env:
      JOB_DEF_FAMILY: ${{ inputs.environment }}-cpo-sv-cpi-batchj01

    steps:
      - name: resolve oidc role arn
        shell: bash
        run: |
          set -euo pipefail
          case "${{ inputs.environment }}" in
            stage) ROLE_ARN="${{ secrets.STAGE_OIDC_ROLE_ARN }}" ;;
            prod)  ROLE_ARN="${{ secrets.PROD_OIDC_ROLE_ARN }}" ;;
            *) echo "Unknown environment"; exit 1 ;;
          esac
          if [ -z "$ROLE_ARN" ]; then
            echo "ERROR: OIDC ROLE ARN secret is empty."
            exit 1
          fi
          echo "ROLE_ARN=$ROLE_ARN" >> "$GITHUB_ENV"

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          role-to-assume: ${{ env.ROLE_ARN }}

      - name: rollback job definition (disable latest)
        shell: bash
        run: |
          set -euo pipefail
          ARNS="$(aws batch describe-job-definitions \
            --job-definition-name "${JOB_DEF_FAMILY}" \
            --status ACTIVE \
            --query 'jobDefinitions | sort_by(@, &revision) | reverse(@)[:2].jobDefinitionArn' \
            --output text)"

          COUNT="$(printf "%s" "${ARNS}" | wc -w | tr -d ' ')"
          if [ "${COUNT}" -lt 2 ]; then
            echo "ERROR: Less than 2 ACTIVE job definitions. Rollback not possible."
            exit 1
          fi

          read -r LATEST_ARN PREV_ARN <<< "${ARNS}"
          echo "Disable (latest): ${LATEST_ARN}"
          echo "Keep (previous) : ${PREV_ARN}"
          aws batch deregister-job-definition --job-definition "${LATEST_ARN}"
